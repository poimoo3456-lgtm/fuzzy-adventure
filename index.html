<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8">
<title>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ QR (‡∏Ñ‡∏£‡∏ö + Excel)</title>
<style>
body{font-family:sans-serif}
section{display:none;margin-top:20px}
video{width:280px;border:1px solid #ccc}
table{border-collapse:collapse;width:100%;margin-top:10px}
td,th{border:1px solid #ccc;padding:6px;text-align:center}
button{margin:4px}
</style>
</head>
<body>

<h2>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>

<!-- LOGIN -->
<section id="login" style="display:block">
  <input id="email" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•"><br>
  <input id="password" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô"><br>
  <button onclick="login()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
</section>

<!-- STUDENT -->
<section id="student">
  <h3>‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
  <input id="sname" placeholder="‡∏ä‡∏∑‡πà‡∏≠">
  <input id="sid" placeholder="‡πÄ‡∏•‡∏Ç‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô"><br><br>

  <video id="video" autoplay></video><br>
  <button onclick="startScan()">‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô QR</button><br><br>

  <button id="lateBtn" onclick="late()" style="display:none;">‡∏™‡∏≤‡∏¢</button>
</section>

<!-- TEACHER -->
<section id="teacher">
  <h3>‡∏Ñ‡∏£‡∏π</h3>
  <input id="subject" placeholder="‡∏ß‡∏¥‡∏ä‡∏≤">
  <input id="room" placeholder="‡∏´‡πâ‡∏≠‡∏á">
  <button onclick="openClass()">‡πÄ‡∏õ‡∏¥‡∏î‡∏Ñ‡∏≤‡∏ö + ‡∏™‡∏£‡πâ‡∏≤‡∏á QR</button>

  <p><b>QR Code</b></p>
  <img id="qrImg"><br>
  <small id="qrText"></small>

  <h4>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h4>
  <button onclick="exportExcel()">üì• Export Excel</button>

  <table id="table">
    <tr><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡πÄ‡∏•‡∏Ç</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡πÄ‡∏ß‡∏•‡∏≤</th></tr>
  </table>
</section>

<!-- ADMIN -->
<section id="admin">
  <h3>Admin</h3>
  <button onclick="closeSystem()">‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
</section>

<script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import {
  getFirestore, doc, getDoc, setDoc, addDoc,
  collection, query, where, onSnapshot,
  serverTimestamp, Timestamp
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

/* ===== CONFIG ===== */
const firebaseConfig = {
  apiKey: "API_KEY",
  authDomain: "PROJECT.firebaseapp.com",
  projectId: "PROJECT"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let classIdGlobal = null;
let attendanceCache = [];

/* ===== LOGIN ===== */
window.login = async () => {
  const res = await signInWithEmailAndPassword(auth,email.value,password.value);
  const snap = await getDoc(doc(db,"users",res.user.uid));
  const role = snap.data().role;

  login.style.display="none";
  if(role==="student") student.style.display="block";
  if(role==="teacher") teacher.style.display="block";
  if(role==="admin") admin.style.display="block";
};

/* ===== STUDENT ===== */
window.startScan = async () => {
  const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
  video.srcObject = stream;

  const canvas=document.createElement("canvas");
  const ctx=canvas.getContext("2d");

  const scan=()=>{
    canvas.width=video.videoWidth;
    canvas.height=video.videoHeight;
    ctx.drawImage(video,0,0);
    const img=ctx.getImageData(0,0,canvas.width,canvas.height);
    const code=jsQR(img.data,img.width,img.height);
    if(code){
      classIdGlobal=code.data;
      stream.getTracks().forEach(t=>t.stop());
      checkIn();
      return;
    }
    requestAnimationFrame(scan);
  };
  scan();
};

async function checkIn(){
  const ref=doc(db,"classes",classIdGlobal);
  const snap=await getDoc(ref);
  if(!snap.exists()) return alert("QR ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");

  const data=snap.data();
  if(Date.now()>data.qrExpireAt.toMillis()){
    lateBtn.style.display="block";
    return alert("‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤");
  }

  await addDoc(collection(db,"attendance"),{
    classId:classIdGlobal,
    name:sname.value,
    sid:sid.value,
    status:"‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô",
    time:serverTimestamp()
  });
  alert("‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß");
}

window.late=async()=>{
  await addDoc(collection(db,"attendance"),{
    classId:classIdGlobal,
    name:sname.value,
    sid:sid.value,
    status:"‡∏™‡∏≤‡∏¢",
    time:serverTimestamp()
  });
  alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
};

/* ===== TEACHER ===== */
window.openClass = async () => {
  classIdGlobal = Date.now().toString();
  await setDoc(doc(db,"classes",classIdGlobal),{
    subject:subject.value,
    room:room.value,
    qrExpireAt:Timestamp.fromMillis(Date.now()+5*60*1000),
    isActive:true
  });

  QRCode.toDataURL(classIdGlobal,(err,url)=>{
    qrImg.src=url;
    qrText.innerText="‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏≤‡∏ö: "+classIdGlobal;
  });

  loadAttendance();
};

function loadAttendance(){
  const q=query(collection(db,"attendance"),where("classId","==",classIdGlobal));
  onSnapshot(q,(snap)=>{
    attendanceCache=[];
    table.innerHTML="<tr><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡πÄ‡∏•‡∏Ç</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡πÄ‡∏ß‡∏•‡∏≤</th></tr>";
    snap.forEach(d=>{
      const a=d.data();
      attendanceCache.push(a);
      table.innerHTML+=`<tr>
        <td>${a.name}</td>
        <td>${a.sid}</td>
        <td>${a.status}</td>
        <td>${a.time?.toDate().toLocaleTimeString()}</td>
      </tr>`;
    });
  });
}

/* ===== EXPORT EXCEL ===== */
window.exportExcel = () => {
  if(attendanceCache.length===0) return alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");

  const data = attendanceCache.map(a=>({
    ‡∏ä‡∏∑‡πà‡∏≠: a.name,
    ‡πÄ‡∏•‡∏Ç‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: a.sid,
    ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: a.status,
    ‡πÄ‡∏ß‡∏•‡∏≤: a.time?.toDate().toLocaleTimeString()
  }));

  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠");

  XLSX.writeFile(wb, "attendance.xlsx");
};

/* ===== ADMIN ===== */
window.closeSystem = async () => {
  await setDoc(doc(db,"systemConfig","main"),{systemOpen:false});
  alert("‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß");
};
</script>
</body>
</html>
